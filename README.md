# 1C8CheckDatabaseAccess

## Описание PowerShell-скрипта

PowerShell-скрипт «1C82CheckDatabaseAccess.ps1» проверяет доступность базы данных на сервере приложений 1С 8.2 путем попытки подключения к базе.

Скрипт предназначен для работы в качестве пользовательского сенсора PRTG.

Результат выполнения возвращается в стандартный поток вывода в формате, требуемом для пользовательского сенсора PRTG.

Код возврата соответствует формату для пользовательского сенсора PRTG.

## Использование скрипта

Имя сервера и имя базы данных должны быть переданы в скрипт через параметры следующим образом:
```
.\1C82CheckDatabaseAccess.ps1 -serverName [имя_сервера] -databaseName [имя_базы_данных]
```
или
```
.\1C82CheckDatabaseAccess.ps1 [имя_сервера] [имя_базы_данных]
```
При настройке и отладке скрипта можно включить вывод подробных сообщений об ошибках. Для вывода таких сообщений добавьте в параметры скрипта ключ «-Verbose»:
```
.\1C82CheckDatabaseAccess.ps1 -serverName [имя_сервера] -databaseName [имя_базы_данных] -Verbose
```

## Установка и настройка окружения для работы скрипта

### 1. Установка Powershell 3.0

Для корректной работы скрипта требуется установить в системе Powershell 3.0, который содержится в Windows Management Framework 3.0: http://www.microsoft.com/en-us/download/details.aspx?id=34595

Узнать текущую установленную версию PowerShell можно с помощью команды:
```
$Host.Version.ToString()
```

### 2. Регистрация DLL-файла «comcntr.dll»

Во время работы скрипта подключение к серверу выполняется через COM-соединение, для этого в системе заранее должен быть зарегистрирован DLL-файл «comcntr.dll» с помощью команды:
```
regsvr32.exe comcntr.dll
```
Версия «comcntr.dll» должна соответствовать версии сервера приложений 1С 8.2.

DLL-файл «comcntr.dll» зависит от следующих файлов (в порядке зависимостей): «stl82.dll», «core82.dll», «icuin46.dll», «icuuc46.dll», «icudt46.dll». Перечисленные файлы должны находится в каталоге с «comcntr.dll».

При появлении ошибки при регистрации DLL-файла с помощью «regsvr32» попробуйте устранить ее одним из следующих способов:
- повторно запустить «regsvr32» в командной строке с повышенными привилегиями;
- использовать 32-разрядную версию «regsvr32» для регистрации 32-разрядной библиотеки в 64-разрядной версии Windows, которая расположена в «%systemroot%\SysWoW64\regsvr32.exe».

Подробнее о «regsvr32» изложено в статье «Использование средства Regsvr32 и устранение неполадок, связанных с выводимыми им сообщениями об ошибках»: http://support.microsoft.com/kb/249873/ru

### 3. Настройка политики выполнения для PowerShell-скрипта

Для запуска скрипта требуется установить политику выполнения «RemoteSigned» для пользователя, от имени которого будет выполняться скрипт. Установить такую политику можно следующей командой:
```
Set-ExecutionPolicy RemoteSigned -Scope CurrentUser
```
Определить текущую политику выполнения в текущей сессии можно с помощью команды:
```
Get-ExecutionPolicy
```

## Возможные результаты выполнении скрипта для анализа доступности базы данных 1С 8.2

| Возвращаемое значение в стандартный поток вывода | Код возврата     |
|--------------------------------------------------|------------------|
| 0:DatabaseAvailable                              | 0 OK             |
| 1:DatabaseBlocked                                | 1 Warning        |
| 2:DatabaseNotFound                               | 2 System error   |
| 3:ServerNotFound                                 | 2 System error   |
| 4:ServerVersionIncorrect                         | 3 Protocol error |
| 5:COMBitWidthIncorrect                           | 2 System error   |
| 6:COMClassUnregistered                           | 2 System error   |
| 7:COMErrorLoading                                | 2 System error   |
| 8:UnknownError                                   | 2 System error   |
