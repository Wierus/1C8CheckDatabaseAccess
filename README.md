# 1C8CheckDatabaseAccess

## Описание PowerShell-скрипта

PowerShell-скрипты «1C82CheckDatabaseAccess.ps1» и «1C82CheckDatabaseAccess_parameterless.ps1» проверяют доступность базы данных на сервере приложений 1С 8.2 путем попытки подключения к базе.

Скрипты предназначен для работы в качестве пользовательского сенсора PRTG.

Результат выполнения возвращается в стандартный поток вывода в формате, требуемом для пользовательского сенсора PRTG.

Код возврата соответствует формату для пользовательского сенсора PRTG.

## Использование скриптов

Есть 2 варианта использования скрипта: с параметрами и без параметров (точнее с параметрами жестко указанными в коде). В общем случае следует использовать скрипт с параметрами («1C82CheckDatabaseAccess.ps1»), и параметры указывать в свойствах сенсора PRTG. Так, при изменении значений параметров (имени сервера и имени базы данных) не будет необходимости изменять код скрипта, а нужно будет всего лишь изменить свойства сенсора. Но, если по каким-либо причинам использование скрипта с параметрами не представляется возможным, то можно заранее указать имя сервера и имя базы данных в коде скрипта, и устанавливать скрипт для сенсора PRTG без параметров.

### Параметры запуска скрипта «1C82CheckDatabaseAccess.ps1»

```
.\1C82CheckDatabaseAccess.ps1 -serverName <имя_сервера> -databaseName <имя_базы_данных> [-Verbose]
```
или
```
.\1C82CheckDatabaseAccess.ps1 <имя_сервера> <имя_базы_данных> [-Verbose]
```

# -serverName <имя_сервера>
#     Имя или IP-адрес сервера приложений 1С
# -databaseName <имя_базы_данных>
#     Имя базы данных на сервере приложений 1С
# -Verbose
#     Включение вывода подробных сообщений об ошибках (опционально, использовать только при отладке)

## Установка и настройка окружения для работы скрипта

### 1. Установка Powershell 3.0

Для корректной работы скрипта требуется установить в системе Powershell 3.0, который содержится в Windows Management Framework 3.0: http://www.microsoft.com/en-us/download/details.aspx?id=34595

Узнать текущую установленную версию PowerShell можно с помощью команды:
```
$Host.Version.ToString()
```

### 2. Регистрация DLL-файла «comcntr.dll»

Во время работы скрипта подключение к серверу выполняется через COM-соединение, для этого в системе заранее должен быть зарегистрирован DLL-файл «comcntr.dll» с помощью команды:
```
regsvr32.exe comcntr.dll
```
Версия «comcntr.dll» должна соответствовать версии сервера приложений 1С 8.2.

DLL-файл «comcntr.dll» зависит от следующих файлов (в порядке зависимостей): «stl82.dll», «core82.dll», «icuin46.dll», «icuuc46.dll», «icudt46.dll». Перечисленные файлы должны находится в каталоге с «comcntr.dll».

При появлении ошибки при регистрации DLL-файла с помощью «regsvr32» попробуйте устранить ее одним из следующих способов:
- повторно запустить «regsvr32» в командной строке с повышенными привилегиями;
- использовать 32-разрядную версию «regsvr32» для регистрации 32-разрядной библиотеки в 64-разрядной версии Windows, которая расположена в «%systemroot%\SysWoW64\regsvr32.exe».

Подробнее о «regsvr32» изложено в статье «Использование средства Regsvr32 и устранение неполадок, связанных с выводимыми им сообщениями об ошибках»: http://support.microsoft.com/kb/249873/ru

### 3. Настройка политики выполнения для PowerShell-скрипта

Для запуска скрипта требуется установить политику выполнения «RemoteSigned» для пользователя, от имени которого будет выполняться скрипт. Установить такую политику можно следующей командой:
```
Set-ExecutionPolicy RemoteSigned -Scope CurrentUser
```
Определить текущую политику выполнения в текущей сессии можно с помощью команды:
```
Get-ExecutionPolicy
```

## Возможные результаты выполнении скрипта для анализа доступности базы данных 1С 8.2

| Возвращаемое значение в стандартный поток вывода | Код возврата     |
|--------------------------------------------------|------------------|
| 0:Database available                             | 0 OK             |
| 1:Database blocked                               | 1 Warning        |
| 2:Database not found                             | 2 System error   |
| 3:Server name cannot be resolved                 | 2 System error   |
| 4:Server not found                               | 2 System error   |
| 5:Server version incorrect                       | 3 Protocol error |
| 6:COM bit width incorrect                        | 2 System error   |
| 7:COM class unregistered                         | 2 System error   |
| 8:COM error loading                              | 2 System error   |
| -1:Unknown error                                 | 2 System error   |
